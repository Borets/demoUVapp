{% extends "base.html" %}

{% block title %}UV Dependency Management Demo{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row">
        <div class="col-12 text-center mb-5">
            <h1 class="display-4 fw-bold">
                <i class="fas fa-project-diagram text-success"></i>
                Dependency Management
            </h1>
            <p class="lead text-muted">Discover UV's advanced dependency resolution and management capabilities</p>
        </div>
    </div>

    <!-- Dependency Tree Visualization -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header bg-success text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-sitemap"></i> Interactive Dependency Tree
                    </h4>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-lg-8">
                            <div id="dependencyTree" class="bg-light p-4 rounded" style="min-height: 300px;">
                                <div class="text-center">
                                    <div class="spinner-border text-success" role="status">
                                        <span class="visually-hidden">Loading dependency tree...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4">
                            <div class="bg-light p-4 rounded">
                                <h5>Project Statistics</h5>
                                <div id="dependencyStats">
                                    <div class="text-center">
                                        <div class="spinner-border text-success" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-4">
                        <button class="btn btn-success" id="loadDependencyTree">
                            <i class="fas fa-refresh"></i> Analyze Dependencies
                        </button>
                        <button class="btn btn-outline-secondary" id="resetDependencyTree">
                            <i class="fas fa-undo"></i> Reset View
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Conflict Resolution Demo -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header bg-warning text-dark">
                    <h4 class="mb-0">
                        <i class="fas fa-exclamation-triangle"></i> Conflict Resolution
                    </h4>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card h-100 border-danger">
                                <div class="card-header bg-danger text-white">
                                    <h5 class="mb-0">
                                        <i class="fas fa-times"></i> Traditional pip
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div id="pipConflictDemo">
                                        <div class="text-center">
                                            <div class="spinner-border text-danger" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mt-3">
                                        <pre class="bg-dark text-light p-3 rounded"><code id="pipOutput">Click "Simulate Conflict" to see pip struggle...</code></pre>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card h-100 border-success">
                                <div class="card-header bg-success text-white">
                                    <h5 class="mb-0">
                                        <i class="fas fa-check"></i> UV Resolution
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div id="uvConflictDemo">
                                        <div class="text-center">
                                            <div class="spinner-border text-success" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mt-3">
                                        <pre class="bg-dark text-light p-3 rounded"><code id="uvOutput">Click "Simulate Conflict" to see UV resolve elegantly...</code></pre>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-4 text-center">
                        <button class="btn btn-warning btn-lg" id="simulateConflict">
                            <i class="fas fa-bolt"></i> Simulate Dependency Conflict
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Lock File Management -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header bg-info text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-lock"></i> Lock File Management
                    </h4>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-lg-8">
                            <div class="card bg-dark text-light">
                                <div class="card-header">
                                    <h6 class="mb-0">
                                        <i class="fas fa-file-code"></i> uv.lock (Sample)
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <pre id="lockFileContent" style="max-height: 300px; overflow-y: auto;"><code>Loading lock file content...</code></pre>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4">
                            <div class="bg-light p-4 rounded">
                                <h5>Lock File Benefits</h5>
                                <ul class="list-unstyled">
                                    <li class="mb-2">
                                        <i class="fas fa-check text-success"></i>
                                        <strong>Reproducible builds</strong> across environments
                                    </li>
                                    <li class="mb-2">
                                        <i class="fas fa-check text-success"></i>
                                        <strong>Cryptographic verification</strong> of packages
                                    </li>
                                    <li class="mb-2">
                                        <i class="fas fa-check text-success"></i>
                                        <strong>Faster installations</strong> with cached metadata
                                    </li>
                                    <li class="mb-2">
                                        <i class="fas fa-check text-success"></i>
                                        <strong>Precise dependency versions</strong>
                                    </li>
                                </ul>
                                <div id="lockFileComparison" class="mt-4">
                                    <!-- Comparison data will be loaded here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Security Analysis -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header bg-dark text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-shield-alt"></i> Security Analysis
                    </h4>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="card border-success">
                                <div class="card-body text-center">
                                    <div class="feature-icon bg-success text-white rounded-circle mx-auto mb-3">
                                        <i class="fas fa-bug fa-2x"></i>
                                    </div>
                                    <h5>Vulnerability Scanning</h5>
                                    <div id="vulnerabilityCount" class="display-6 text-success">0</div>
                                    <p class="text-muted">Known vulnerabilities found</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card border-info">
                                <div class="card-body text-center">
                                    <div class="feature-icon bg-info text-white rounded-circle mx-auto mb-3">
                                        <i class="fas fa-certificate fa-2x"></i>
                                    </div>
                                    <h5>Hash Verification</h5>
                                    <div id="hashVerification" class="display-6 text-info">SHA-256</div>
                                    <p class="text-muted">Cryptographic integrity</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card border-warning">
                                <div class="card-body text-center">
                                    <div class="feature-icon bg-warning text-white rounded-circle mx-auto mb-3">
                                        <i class="fas fa-gavel fa-2x"></i>
                                    </div>
                                    <h5>License Compliance</h5>
                                    <div id="licenseCompliance" class="display-6 text-warning">✓</div>
                                    <p class="text-muted">All licenses compatible</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-4">
                        <button class="btn btn-dark" id="runSecurityScan">
                            <i class="fas fa-search"></i> Run Security Scan
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Command Comparison -->
    <div class="row">
        <div class="col-12">
            <div class="card bg-light">
                <div class="card-body">
                    <h3 class="text-center mb-4">Command Comparison</h3>
                    <div class="row g-4">
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header bg-danger text-white">
                                    <h5 class="mb-0">
                                        <i class="fas fa-snail"></i> Traditional Workflow
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <pre class="bg-dark text-light p-3 rounded"><code># Create requirements file
pip freeze > requirements.txt

# Install dependencies
pip install -r requirements.txt

# Update dependencies (manual)
pip install --upgrade package-name
pip freeze > requirements.txt

# Check for vulnerabilities
pip-audit

# Resolve conflicts manually
# (often fails or requires manual intervention)</code></pre>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header bg-success text-white">
                                    <h5 class="mb-0">
                                        <i class="fas fa-rocket"></i> UV Workflow
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <pre class="bg-dark text-light p-3 rounded"><code># Add dependencies with automatic lock file
uv add fastapi uvicorn pandas

# Install from lock file (reproducible)
uv sync

# Update dependencies
uv lock --upgrade

# Built-in security scanning
uv audit

# Automatic conflict resolution
# (intelligent dependency solver)</code></pre>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let dependencyData = null;
let conflictData = null;

// Load dependency analysis
async function loadDependencyAnalysis() {
    try {
        const response = await fetch('/api/dependencies/analysis');
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        dependencyData = await response.json();
        
        // Check if we have valid data before proceeding
        if (dependencyData && dependencyData.dependency_tree) {
            displayDependencyTree(dependencyData.dependency_tree);
        } else {
            throw new Error('Invalid dependency data structure');
        }
        
        if (dependencyData && dependencyData.statistics) {
            displayDependencyStats(dependencyData.statistics);
        }
    } catch (error) {
        console.error('Error loading dependency analysis:', error);
        document.getElementById('dependencyTree').innerHTML = '<p class="text-danger">Failed to load dependency data: ' + error.message + '</p>';
        document.getElementById('dependencyStats').innerHTML = '<p class="text-danger">Failed to load stats</p>';
    }
}

// Display dependency tree
function displayDependencyTree(tree) {
    const container = document.getElementById('dependencyTree');
    
    // Safety check for null/undefined tree
    if (!tree || typeof tree !== 'object') {
        container.innerHTML = '<p class="text-warning">No dependency tree data available</p>';
        return;
    }
    
    let html = '<div class="dependency-tree">';
    
    Object.entries(tree).forEach(([packageName, info]) => {
        // Safety checks for info properties
        if (!info || typeof info !== 'object') {
            return; // Skip invalid entries
        }
        
        const isDirectClass = info.is_direct ? 'border-primary' : 'border-secondary';
        const badgeClass = info.is_direct ? 'bg-primary' : 'bg-secondary';
        const version = info.version || 'unknown';
        const sizeMb = info.size_mb || 0;
        const license = info.license || 'unknown';
        const dependencies = Array.isArray(info.dependencies) ? info.dependencies : [];
        
        html += `
            <div class="card mb-3 ${isDirectClass}">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="card-title">
                                ${packageName} 
                                <span class="badge ${badgeClass}">${version}</span>
                                ${info.is_direct ? '<span class="badge bg-success">Direct</span>' : '<span class="badge bg-light text-dark">Transitive</span>'}
                            </h6>
                            <p class="card-text">
                                <small class="text-muted">
                                    Size: ${sizeMb} MB | License: ${license}
                                </small>
                            </p>
                            ${dependencies.length > 0 ? `
                                <div class="mt-2">
                                    <small><strong>Dependencies:</strong></small>
                                    <div class="mt-1">
                                        ${dependencies.map(dep => `<span class="badge bg-light text-dark me-1">${dep}</span>`).join('')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    container.innerHTML = html;
}

// Display dependency statistics
function displayDependencyStats(stats) {
    const container = document.getElementById('dependencyStats');
    
    // Safety check for stats object
    if (!stats || typeof stats !== 'object') {
        container.innerHTML = '<p class="text-warning">No statistics data available</p>';
        return;
    }
    
    const totalPackages = stats.total_packages || 0;
    const directDeps = stats.direct_dependencies || 0;
    const transitiveDeps = stats.transitive_dependencies || 0;
    const totalSize = stats.total_size_mb || 0;
    
    container.innerHTML = `
        <div class="row g-3">
            <div class="col-6">
                <div class="text-center">
                    <div class="display-6 text-success">${totalPackages}</div>
                    <small class="text-muted">Total Packages</small>
                </div>
            </div>
            <div class="col-6">
                <div class="text-center">
                    <div class="display-6 text-primary">${directDeps}</div>
                    <small class="text-muted">Direct Dependencies</small>
                </div>
            </div>
            <div class="col-6">
                <div class="text-center">
                    <div class="display-6 text-warning">${transitiveDeps}</div>
                    <small class="text-muted">Transitive</small>
                </div>
            </div>
            <div class="col-6">
                <div class="text-center">
                    <div class="display-6 text-info">${totalSize}</div>
                    <small class="text-muted">Total MB</small>
                </div>
            </div>
        </div>
    `;
}

// Simulate conflict resolution
async function simulateConflict() {
    document.getElementById('simulateConflict').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Simulating...';
    
    // Simulate loading time
    await new Promise(resolve => setTimeout(resolve, 2000));
    
    // Show pip failure
    document.getElementById('pipOutput').textContent = `
ERROR: Could not find compatible versions
Dependency resolution failed after 8 attempts
Time elapsed: 45.2s
Resolution: FAILED ❌`;
    
    document.getElementById('pipConflictDemo').innerHTML = `
        <div class="alert alert-danger">
            <h6><i class="fas fa-times"></i> Resolution Failed</h6>
            <p>Found 3 conflicts</p>
            <small>Traditional pip often fails with complex dependency trees</small>
        </div>
    `;
    
    // Show UV success
    document.getElementById('uvOutput').textContent = `
✅ Successfully resolved all dependencies
Found and resolved 3 conflicts
Time elapsed: 1.8s
Resolution: SUCCESS ✅`;
    
    document.getElementById('uvConflictDemo').innerHTML = `
        <div class="alert alert-success">
            <h6><i class="fas fa-check"></i> Resolution Successful</h6>
            <p>Resolved 3 conflicts intelligently</p>
            <small>25.1x faster resolution</small>
        </div>
    `;
    
    document.getElementById('simulateConflict').innerHTML = '<i class="fas fa-bolt"></i> Simulate Dependency Conflict';
}

// Load lock file content
function loadLockFileContent() {
    document.getElementById('lockFileContent').innerHTML = `
<span class="text-info"># UV Lock File (Sample)</span>
<span class="text-warning">version = 1</span>
<span class="text-warning">requires-python = ">=3.9"</span>

<span class="text-success">[[package]]</span>
<span class="text-primary">name = "fastapi"</span>
<span class="text-primary">version = "0.104.1"</span>
<span class="text-primary">source = { registry = "https://pypi.org/simple" }</span>
<span class="text-primary">dependencies = [</span>
<span class="text-primary">    "starlette>=0.27.0",</span>
<span class="text-primary">    "pydantic>=2.4.0",</span>
<span class="text-primary">]</span>
<span class="text-primary">wheels = [</span>
<span class="text-primary">    { url = "https://pypi.org/packages/...", hash = "sha256:..." },</span>
<span class="text-primary">]</span>

<span class="text-muted"># ... and 40+ more packages</span>
    `;
    
    // Show comparison
    document.getElementById('lockFileComparison').innerHTML = `
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">Lock File Comparison</h6>
            </div>
            <div class="card-body">
                <div class="row g-2 text-center">
                    <div class="col-4">
                        <div class="text-danger">
                            <strong>pip freeze</strong><br>
                            <small>2.1 KB</small><br>
                            <small>Limited</small>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="text-warning">
                            <strong>poetry.lock</strong><br>
                            <small>125.7 KB</small><br>
                            <small>Good</small>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="text-success">
                            <strong>uv.lock</strong><br>
                            <small>89.3 KB</small><br>
                            <small>Excellent</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
}

// Run security scan
async function runSecurityScan() {
    const scanButton = document.getElementById('runSecurityScan');
    scanButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Scanning...';
    
    // Simulate scan time
    await new Promise(resolve => setTimeout(resolve, 3000));
    
    document.getElementById('vulnerabilityCount').textContent = '0';
    document.getElementById('hashVerification').innerHTML = `<i class="fas fa-check text-success"></i>`;
    document.getElementById('licenseCompliance').innerHTML = `<i class="fas fa-check text-success"></i>`;
    
    scanButton.innerHTML = '<i class="fas fa-check"></i> Scan Complete - All Clear!';
    scanButton.classList.remove('btn-dark');
    scanButton.classList.add('btn-success');
}

// Event listeners
document.getElementById('loadDependencyTree').addEventListener('click', loadDependencyAnalysis);
document.getElementById('resetDependencyTree').addEventListener('click', () => {
    document.getElementById('dependencyTree').innerHTML = '<p class="text-muted text-center">Click "Analyze Dependencies" to view dependency tree</p>';
    document.getElementById('dependencyStats').innerHTML = '<p class="text-muted text-center">No analysis data</p>';
});
document.getElementById('simulateConflict').addEventListener('click', simulateConflict);
document.getElementById('runSecurityScan').addEventListener('click', runSecurityScan);

// Load initial data
loadDependencyAnalysis();
loadLockFileContent();
</script>
{% endblock %}